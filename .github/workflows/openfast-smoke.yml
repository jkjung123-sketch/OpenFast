
name: openfast-smoke

on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/openfast-smoke.yml"

jobs:
  run-openfast-iea15mw:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Mambaforge
        uses: conda-incubator/setup-miniconda@v3
        with:
          activate-environment: of_env
          python-version: "3.10"
          auto-activate-base: false

      - name: Install OpenFAST & tools (conda-forge)
        shell: bash -l {0}
        run: |
          mamba install -y -c conda-forge openfast pandas numpy
          openfast --version

      - name: Fetch IEA-15MW model
        shell: bash -l {0}
        run: |
          mkdir -p models
          git clone --depth=1 https://github.com/IEAWindSystems/IEA-15-240-RWT models/IEA-15-240-RWT

      - name: Get ROSCO libdiscon (Linux .so)
        shell: bash -l {0}
        run: |
          mkdir -p controllers/bin
          wget -qO controllers/bin/libdiscon.so \
            https://github.com/NREL/ROSCO/releases/latest/download/libdiscon.so || \
          (echo "Could not fetch ROSCO libdiscon.so. Please pin a version in this step." && exit 1)
          chmod +x controllers/bin/libdiscon.so

      - name: Prepare IEA-15MW Monopile case for ROSCO
        shell: bash -l {0}
        run: |
          mkdir -p runs/rosco
          cp -r models/IEA-15-240-RWT/OpenFAST/IEA-15-240-RWT-Monopile runs/rosco/
          SD="runs/rosco/IEA-15-240-RWT-Monopile_ServoDyn.dat"
          sed -i 's|DLL_FileName.*|\"../../controllers/bin/libdiscon.so\"    DLL_FileName|' "$SD"
          sed -i 's|DLL_InFile.*|\"IEA-15-240-RWT-Monopile_DISCON.IN\"        DLL_InFile|' "$SD"

      - name: Run OpenFAST (IEA-15MW Monopile with ROSCO)
        shell: bash -l {0}
        working-directory: runs/rosco/IEA-15-240-RWT-Monopile
        run: |
          set -e
          echo ">>> Running OpenFAST ..."
          openfast IEA-15-240-RWT-Monopile.fst | tee openfast.log
          echo ">>> Done."

      - name: Summarize outputs
        shell: bash -l {0}
        run: |
          python - << 'PY'
          import glob, pandas as pd, os
          outs = glob.glob("runs/rosco/IEA-15-240-RWT-Monopile/*.out*")
          def read_text_out(f):
              with open(f,"r",encoding="utf-8",errors="ignore") as fh:
                  lines = fh.readlines()
              ix = None
              for i,l in enumerate(lines):
                  if l.strip().startswith("Time"):
                      ix=i
              if ix is None: 
                  return None
              cols = lines[ix].split()
              data=[]
              for l in lines[ix+1:]:
                  if not l.strip(): break
                  parts = l.split()
                  try:
                      data.append([float(x) for x in parts])
                  except:
                      break
              return pd.DataFrame(data, columns=cols)
          df=None
          for f in outs:
              if f.endswith(".out") or (not f.endswith(".outb")):
                  df = read_text_out(f)
                  if df is not None: break
          os.makedirs("results", exist_ok=True)
          with open("results/openfast_summary.md","w") as fh:
              fh.write("# OpenFAST Smoke Test (IEA-15MW Monopile)\n\n")
              if df is None:
                  fh.write("- 결과 요약을 생성할 .out 텍스트 파일을 찾지 못했습니다.\n")
              else:
                  cols = df.columns
                  pcol = [c for c in cols if "GenPwr" in c]
                  T = df["Time_[s]"].iloc[-1] if "Time_[s]" in cols else None
                  P = df[pcol[0]].mean() if pcol else None
                  if T is not None: fh.write(f"- 시뮬레이션 시간(최종 Time): **{T:.1f} s**\n")
                  if P is not None: fh.write(f"- 평균 전기출력(GenPwr): **{P:.1f} kW**\n")
          print(open("results/openfast_summary.md","r").read())
          PY

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openfast-iea15mw-rosco
          path:
            - runs/rosco/IEA-15-240-RWT-Monopile/*.out*
            - runs/rosco/IEA-15-240-RWT-Monopile/openfast.log
            - results/openfast_summary.md
